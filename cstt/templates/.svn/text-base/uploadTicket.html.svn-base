<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Dateiupload für Ticket-Nr.: <%= ticketNumber %></title>
  <link rel="stylesheet" type="text/css" href="../../ext-4.0/resources/css/ext-all.css">
	<script type="text/javascript" src="../../ext-4.0/ext-all.js"></script>  
<script src="../../js/json2.js"></script>
    <script src="../../js/sha1.js"></script>
    <script src="../../js/jquery.js?1.4.2"></script>
    <script src="../../js/jquery.couch.js?0.11.0"></script>
    <script src="../../js/jquery.dialog.js?0.11.0"></script>
	 <script src="../../js/jquery.form.js"></script>

</head>

<body>

<h1>Datei/en hochladen zu Ticket-Nr.: <%= ticketNumber %></h1>
<br />
<form id="upload-form" action="#">

<p>
Datei ausw&auml;hlen:
<input type="file" name="_attachments">
</p>

<p>
<button type="submit">Datei hochladen ...</button>
</p>

<input type="hidden" name="_rev" value="<%= rev %>">
</form>

</body>
</html>


<script type="text/javascript" charset="utf-8">



        //Ext.require('Ext.window.MessageBox');

        Ext.onReady(function(){



$("#upload-form").submit(function(e) { // invoke callback on submit
  e.preventDefault();
  var data = {};
  $.each($("form :input").serializeArray(), function(i, field) {
    data[field.name] = field.value;
  });
  $("form :file").each(function() {
    data[this.name] = this.value; // file inputs need special handling
  });

  if (!data._attachments || data._attachments.length == 0) {
     Ext.MessageBox.show({
		title: 'Fehler',
		msg: 'Bitte w&auml;hlen Sie eine Datei aus!',
		buttons: Ext.MessageBox.OK,
		icon: Ext.MessageBox.ERROR
	});	
    return;
  }
 Ext.MessageBox.wait('Datei wird hochgeladen ...', 'Bitte warten ...');
  $(this).ajaxSubmit({
    url:  "../../../../<%= docid %>",
    success: function(resp) {

	var json = resp;
	// HTML Tags wegen iFrame Upload bei der Rückgabe entfernen
	json = json.replace(/<(?:.|\s)*?>/g, "");
    // JSON String zu Objekt umwandeln
	var jsonObj = JSON.parse(json);

	
if(jsonObj.ok !== undefined) {
	Ext.MessageBox.hide();
	// Seite neu laden, damit _rev passt!
	location.reload(true);
	}

if(jsonObj.error !== undefined) {
Ext.MessageBox.hide();
   Ext.MessageBox.show({
		title: 'Fehler',
		msg: 'Die Datei konnte nicht hochgeladen werden. Bitte versuchen Sie es erneut.<br/><b>Grund</b>: '+jsonObj.reason,
		buttons: Ext.MessageBox.OK,
		icon: Ext.MessageBox.ERROR
	});	
}
    }
    
    
  });
});
});
</script>
	    
