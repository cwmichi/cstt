/*
 * File: app/view/actionCommentGrid.js
 *
 * This file was generated by Sencha Designer version 2.0.0.
 * http://www.sencha.com/products/designer/
 *
 * This file requires use of the Ext JS 4.0.x library, under independent license.
 * License of Sencha Designer does not include license for Ext JS 4.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * You should implement event handling and custom methods in this
 * class.
 */

Ext.define('cstt.view.actionCommentGrid', {
    extend: 'cstt.view.ui.actionCommentGrid',
    alias: 'widget.actionCommentGrid',

    initComponent: function() {
        var me = this;
        me.callParent(arguments);
    },

    onRefreshClick: function(button, e, options) {
        this.store.load({
            params: {
                "key": '"'+this.couchDBDocID+'"'
            }
        });
    },

    onEditClick: function(button, e, options, changeStatus) {
    	
        // selectAction ist der Data Record!
        selectAction = this.getView().getSelectionModel().getSelection()[0];
       
        if (selectAction) {	
        	
        	
            // Nur der aktuell angemeldete User kann seine eigenen Aktionen/Kommentare editieren oder Admins / TCOB !!!
        	// und auch Ticket-Ersteller darf die Aktionen ändern
            if(selectAction.get('staff_ID')==sessionUserID||isAdmin===true||isTCOB===true||this.ticketRecord.get('owner')==sessionUserID){

            	
            	
                var actionWindow = Ext.widget('actionWindow');
                actionWindow.couchDBTicketDocID = this.couchDBDocID;

                actionWindow.actionCommentGridExtJsID = this.getId();

                actionWindow.setTitle('Aktion/Kommentar editieren ...');
                actionWindow.down('#actionLabel').setValue('Aktion/Kommentar editieren');
                actionWindow.down('#emailTo').destroy();

                if (changeStatus == 'changeMe') {
                
                	
                	actionWindow.down('#status').destroy();                
                	
					var form = actionWindow.down('form');
					form.down('#column_left').add({xtype: 'displayfield', value: '<br/>'},{
						xtype: 'combo',
						name: 'status',
						itemId: 'changeStatus',
						oldStatus: selectAction.get('status'),
						fieldLabel: 'Status &auml;ndern',				
						displayField: 'statusText',
						anchor: '45%',
						forceSelection: true,
						queryMode: 'local',
						store: 'actionStatusStore',
						valueField: 'status'
					});
                
                }
                
             
                
                actionWindow.down('form').getForm().loadRecord(selectAction);	
                actionWindow.down('#save').hide();
                actionWindow.down('#edit').show();	
                actionWindow.doLayout();
                actionWindow.setSize(980,630);	
                
			if (changeStatus == 'changeMe' && selectAction.get('status') == 0) {   
				
				actionWindow.close();

            	 Ext.MessageBox.show({
                    title: 'Letzten Status ändern nicht m&ouml;glich',
                    msg: 'Der letzte Status kann nicht ge&auml;ndert werden, da dieses Ticket bereits geschlossen ist!',
                    buttons: Ext.MessageBox.OK,
                    icon: Ext.MessageBox.ERROR
                });	
                
            }	
            
            } else {
            
            Ext.MessageBox.show({
                    title: 'Editieren nicht möglich',
                    msg: 'Nur eigene Aktionen/Kommentare k&ouml;nnen editiert werden!',
                    buttons: Ext.MessageBox.OK,
                    icon: Ext.MessageBox.ERROR
                });	
            
            
            
            }

        }
        else {
            Ext.MessageBox.show({
                title: 'Hinweis',
                msg: 'Bitte wählen Sie zuerst eine Aktion/Kommentar aus, den Sie editieren möchten.',
                buttons: Ext.MessageBox.OK,
                icon: Ext.MessageBox.INFO
            });
        }
    }, 
    onChangeStatusClick: function(button, e, options) {
    	
	   	// Aktion Grid ueberpruefen, ob Eintraege im Grid vorhanden sind, ansonsten Fehlermeldung anzeigen
    	if(this.getStore().getCount() > 0) {
    		
    		// Sortierung des Grid korrigieren & aktuelle Daten holen    		
			this.getStore().load({
				params: {
                	"key": '"'+this.couchDBDocID+'"'
            	},
			    scope: this,
			    callback: function(records, operation, success) {
			        this.getStore().sort('createdOn', 'DESC');
					this.getView().select(0)
					this.onEditClick(button, e, options, 'changeMe');
			    }
			});
			    		
    		
    	} else {
    		Ext.MessageBox.show({
                title: 'Hinweis',
                msg: 'Letzter Status kann nicht geändert werden!',
                buttons: Ext.MessageBox.OK,
                icon: Ext.MessageBox.INFO
            });
    	}
    	
    }
});